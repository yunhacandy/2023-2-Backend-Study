# WIL8

Spring Data JPA
---
### 영속성 컨텍스트
영속성 컨텍스트는 엔티티를 영구적으로 저장하는 환경이다.   
쉽게 말해서 객체를 데이터베이스에서 조회했을 때, 이를 캐싱하여 더 효율적으로 작동하도록 돕는 시스템이다.   

##### 영속성 컨텍스트의 이점
1. 캐싱
2. 동일성 보장
3. 트랜잭션을 지원하는 쓰기 지연 (transactional write-behind)
4. 변경 감지 (Dirty Checking)
5. 지연 로딩 (Lazy Loading)

### Update
객체를 변경할 때, 영속성 컨텍스트의 변경 감지를 이용하면 된다.   
영속성 컨텍스트의 변경 감지 기능 때문에, db에는 변경된 정보가 저장됨을 알 수 있다.

### Delete
Spring Data Jpa에서 기본적인 함수를 제공해준다.   
deleteAll(), deleteById() 등이 있는데 상황에 맞춰서 사용하면 된다.   

### JPA 사용시 주의점
* 엔티티 설계   
    필요하지 않은 연관 관계를 피하며, 무한 순환 참조를 방지해야 한다.
  1. @JsonIgnore   
     이 어노테이션을 붙이면 JSON 데이터에 해당 프로퍼티는 null로 들어가게 된다.   
     즉, 데이터에 아예 포함시키지 않는다.   

  2. DTO 사용   
     이 상황이 발생한 이유는 Entity 자체를 response로 리턴한데에 있다.   
     DTO 객체를 만들어 필요한 데이터만 옮겨담아 Client로 리턴하면, 순환 참조 관련 문제를 방지 할 수 있다.   
* 지연 로딩   
  연관 관계를 지연 로딩으로 설정해야한다.   
  즉시로딩( EAGER )은 예측이 어렵고, 어떤 SQL이 실행될지 추적하기 어렵다.   
  위와 같은 현상이 발생할 수도 있다.   
* N+1 문제   
  객체를 데이터베이스에서 불러올 때 연관관계가 있는 객체에서 1개의 쿼리가 아닌 N개의 쿼리가 추가로 생성되는 문제이다.   
  이는 아래와 같은 방법으로 해결할 수 있습니다.
  1. JPQL의 Fetch Join 사용하기   
  Fetch Join은 표면상으로는 SQL의 Join문과 달라보이지 않는다. 하지만 Fetch Join은 JPQL의 성능 처리를 위해 JPQL에만 있는 쿼리이다.
  2. BatchSize 사용하기   
  BatchSize는 N+1문제를 최대한 in쿼리로 기본적인 성능을 보장해주는 것이다.